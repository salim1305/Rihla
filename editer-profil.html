<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Éditer le profil – Rihla</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<header class="navbar">
  <nav class="nav-container">
    <a href="index.html" class="nav-logo"><img src="Logo simple.jpg" alt="Rihla"></a>
    <div class="nav-links">
      <a href="profil.html">Profil</a>
      <a href="connexion.html">Déconnexion</a>
    </div>
  </nav>
</header>
<main class="container">
  <h1>Éditer mon profil</h1>
  <form id="editProfileForm" enctype="multipart/form-data">
    <div class="grid-2">
      <div>
        <label>Prénom</label>
        <input type="text" name="firstname" id="firstname" required>
      </div>
      <div>
        <label>Nom</label>
        <input type="text" name="lastname" id="lastname" required>
      </div>
    </div>
    <label>Email</label>
    <input type="email" name="email" id="email" required disabled>
    <label>Photo de profil</label>
    <input type="file" name="avatar" id="avatar" accept="image/*">
    <div style="margin:10px 0;">
      <img id="avatarPreview" src="assets/avatar.png" alt="Aperçu avatar" style="width:80px;height:80px;border-radius:50%;object-fit:cover;display:block;">
    </div>
    <div class="form-actions">
      <button type="submit" class="btn-primary">Enregistrer</button>
      <a href="profil.html" class="btn-secondary">Annuler</a>
    </div>
  </form>
</main>
<script src="app.js"></script>
</main>
<script type="module">
import { getProfile, updateProfile } from './js/user.js';

// Pré-remplir le formulaire avec les infos actuelles
document.addEventListener('DOMContentLoaded', async () => {
  try {
    const data = await getProfile();
    // Découper le nom si possible
    let firstname = '', lastname = '';
    if (data?.name) {
      const parts = data.name.split(' ');
      firstname = parts[0] || '';
      lastname = parts.slice(1).join(' ');
    }
    document.getElementById('firstname').value = firstname;
    document.getElementById('lastname').value = lastname;
    document.getElementById('email').value = data.email || '';
    // Afficher l'avatar actuel si présent
    if (data.avatar) {
      document.getElementById('avatarPreview').src = data.avatar;
    }
  } catch (e) {
    alert("Erreur lors du chargement du profil.");
  }
});

// Soumission du formulaire
document.getElementById('editProfileForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const firstname = document.getElementById('firstname').value.trim();
  const lastname = document.getElementById('lastname').value.trim();
  const name = `${firstname} ${lastname}`.trim();
  const avatarInput = document.getElementById('avatar');
  const formData = new FormData();
  formData.append('name', name);
  if (avatarInput.files && avatarInput.files[0]) {
    formData.append('avatar', avatarInput.files[0]);
  }
  try {
    await updateProfile(formData, true); // true = multipart
    alert('Profil mis à jour !');
    window.location.href = 'profil.html';
  } catch (err) {
    alert(err.message || "Erreur lors de la mise à jour.");
  }
// Aperçu de la photo sélectionnée
document.getElementById('avatar').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(evt) {
      document.getElementById('avatarPreview').src = evt.target.result;
    };
    reader.readAsDataURL(file);
  }
});
});
</script>
</body>
</html>
